================================================================================
REAL ESTATE OS - RESTORE PROCEDURES QUICK REFERENCE
================================================================================
Last Updated: 2025-11-03
Last Verified: 2025-11-03 (Weekly automated test)
Next Verification: 2025-11-10

This document provides step-by-step restore commands for common scenarios.
For detailed procedures, see RUNBOOKS/restore.md

================================================================================
SCENARIO 1: POINT-IN-TIME RECOVERY (PITR)
================================================================================

When to use: Accidental data deletion, need to restore to specific time

Prerequisites:
  - Determine exact recovery time (YYYY-MM-DD HH:MM:SS format)
  - Notify team and create incident ticket
  - Ensure WAL archives available for target time

Commands:
---------

# 1. Stop services
sudo systemctl stop realestate-api realestate-workers postgresql

# 2. Backup current state (safety)
sudo mv /var/lib/postgresql/14/main /var/lib/postgresql/14/main.backup.$(date +%Y%m%d-%H%M%S)
sudo mkdir -p /var/lib/postgresql/14/main
sudo chown postgres:postgres /var/lib/postgresql/14/main

# 3. Execute PITR restore (replace timestamp with target)
sudo -u postgres pgbackrest \
    --stanza=realestate-db \
    --type=time \
    --target="2025-11-03 14:30:00" \
    --target-action=promote \
    --delta \
    restore

# 4. Start PostgreSQL
sudo systemctl start postgresql

# 5. Verify recovery
sudo -u postgres psql -c "SELECT pg_is_in_recovery();"  # Should return 'f'
sudo -u postgres psql -d realestate -c "SELECT MAX(created_at) FROM properties;"

# 6. Start application
sudo systemctl start realestate-api realestate-workers

# 7. Health check
curl http://localhost:8000/health

Expected Result: Database restored to exact timestamp, all data before that point intact
Typical Duration: 2-3 minutes
Last Test Result: SUCCESS (RTO: 1m52s, RPO: 5m)

================================================================================
SCENARIO 2: FULL DATABASE RESTORE
================================================================================

When to use: Database corruption, restore from latest backup (no specific time needed)

Commands:
---------

# 1. Stop services
sudo systemctl stop realestate-api realestate-workers postgresql

# 2. Check available backups
sudo -u postgres pgbackrest --stanza=realestate-db info

# 3. Restore latest backup
sudo -u postgres pgbackrest --stanza=realestate-db --delta restore

# 4. Start and verify
sudo systemctl start postgresql
sudo -u postgres psql -d realestate -c "SELECT COUNT(*) FROM properties;"

Expected Result: Database restored to last backup (max 6 hours old)
Typical Duration: 2-4 minutes
Last Test Result: SUCCESS (RTO: 3m15s)

================================================================================
SCENARIO 3: MINIO OBJECT RESTORE (DELETE MARKER REMOVAL)
================================================================================

When to use: File accidentally deleted, restore latest version

Commands:
---------

# 1. List all versions including delete marker
mc ls --versions myminio/realestate-memos/memos/prop-12345/memo.pdf

# Example output:
# [2025-11-03 14:35:22 UTC]   0 B  v4-DELETE investor-memo.pdf (DELETE marker)
# [2025-11-03 10:15:10 UTC] 1.2 MB v3 investor-memo.pdf
# [2025-11-02 16:22:33 UTC] 1.1 MB v2 investor-memo.pdf

# 2. Remove delete marker (replace version ID)
mc rm --vid v4-DELETE myminio/realestate-memos/memos/prop-12345/memo.pdf

# 3. Verify restoration
mc stat myminio/realestate-memos/memos/prop-12345/memo.pdf

Expected Result: Latest version (v3) becomes current again
Typical Duration: <1 second
Last Test Result: SUCCESS (0.05s)

================================================================================
SCENARIO 4: MINIO OBJECT RESTORE (SPECIFIC VERSION)
================================================================================

When to use: Need older version, not just latest

Commands:
---------

# 1. List versions
mc ls --versions myminio/realestate-memos/memos/prop-12345/memo.pdf

# 2. Copy specific version to new object
mc cp --vid v2-20251102-162233 \
    myminio/realestate-memos/memos/prop-12345/memo.pdf \
    myminio/realestate-memos/memos/prop-12345/memo-v2-restored.pdf

# 3. Verify
mc stat myminio/realestate-memos/memos/prop-12345/memo-v2-restored.pdf

# 4. Optional: Replace current with old version
mc cp --vid v2-20251102-162233 \
    myminio/realestate-memos/memos/prop-12345/memo.pdf \
    myminio/realestate-memos/memos/prop-12345/memo.pdf

Expected Result: Specific version restored
Typical Duration: <1 second
Last Test Result: SUCCESS (0.23s for 50MB file)

================================================================================
SCENARIO 5: MINIO BUCKET MIRROR RESTORE
================================================================================

When to use: Entire bucket lost, restore from backup site

Commands:
---------

# 1. Verify backup bucket
mc ls s3backup/realestate-memos/

# 2. Mirror from backup to primary
mc mirror s3backup/realestate-memos/ myminio/realestate-memos/

# 3. Compare counts
mc du s3backup/realestate-memos/
mc du myminio/realestate-memos/

# 4. Verify sample objects
mc ls myminio/realestate-memos/ | head -10 | while read line; do
    file=$(echo $line | awk '{print $NF}')
    mc stat myminio/realestate-memos/$file
done

Expected Result: All objects replicated to primary
Typical Duration: ~5 minutes for 5GB
Last Test Result: Not tested (bucket never lost)

================================================================================
SCENARIO 6: ROLLBACK FAILED RESTORE
================================================================================

When to use: Restore failed or incorrect target time

Commands:
---------

# 1. Stop PostgreSQL
sudo systemctl stop postgresql

# 2. Remove failed restore
sudo rm -rf /var/lib/postgresql/14/main

# 3. Restore original backup directory
sudo mv /var/lib/postgresql/14/main.backup.* /var/lib/postgresql/14/main

# 4. Start PostgreSQL
sudo systemctl start postgresql

# 5. Verify
sudo -u postgres psql -d realestate -c "SELECT NOW(), COUNT(*) FROM properties;"

Expected Result: Database back to pre-restore state
Typical Duration: 30 seconds
Last Test Result: SUCCESS (tested during weekly drill)

================================================================================
VALIDATION CHECKLIST (Run after ANY restore)
================================================================================

PostgreSQL Validation:
----------------------
 □ sudo -u postgres psql -c "SELECT pg_is_in_recovery();"
   Expected: f (false)

 □ sudo -u postgres psql -d realestate -c "SELECT COUNT(*) FROM properties;"
   Expected: >0 rows

 □ sudo -u postgres psql -d realestate -c "SELECT MAX(created_at) FROM timeline_entries;"
   Expected: Timestamp makes sense for restore target

 □ curl http://localhost:8000/health
   Expected: {"status": "healthy"}

 □ curl -H "Authorization: Bearer $TOKEN" http://localhost:8000/v1/properties?limit=1
   Expected: Valid JSON response

MinIO Validation:
-----------------
 □ mc stat myminio/realestate-memos/
   Expected: Bucket accessible

 □ mc ls myminio/realestate-memos/ | wc -l
   Expected: >0 objects

 □ mc cat myminio/realestate-memos/memos/sample.pdf | sha256sum
   Expected: Valid checksum (compare with original if available)

 □ file <(mc cat myminio/realestate-memos/memos/sample.pdf)
   Expected: PDF document, version 1.7

Application Validation:
-----------------------
 □ Login to UI
   Expected: Successful login

 □ View property list
   Expected: Properties visible

 □ Open property detail
   Expected: All fields populated

 □ Download memo
   Expected: PDF downloads and opens correctly

================================================================================
COMMON ERRORS & SOLUTIONS
================================================================================

Error: "WAL archive not found"
Solution: WAL segment may have been pruned. Restore to last available backup.
Command: sudo -u postgres pgbackrest --stanza=realestate-db --type=immediate restore

Error: "Restore timeout after 1 hour"
Solution: Increase parallel processes for faster restore.
Command: Add --process-max=8 to pgbackrest command

Error: "MinIO object version not found"
Solution: Version may have expired per lifecycle policy. Check backup site.
Command: aws s3 cp s3://realestate-backup/memos/... myminio/realestate-memos/...

Error: "Database in recovery mode stuck"
Solution: Check recovery.signal file and PostgreSQL logs.
Command: tail -f /var/log/postgresql/postgresql-14-main.log

Error: "Replication lag too high"
Solution: Check network connectivity to backup site.
Command: mc admin trace backup-minio

================================================================================
EMERGENCY CONTACTS
================================================================================

On-Call Ops:      +1-555-0100  ops@realestate.io
Database Team:    +1-555-0101  dba@realestate.io
DevOps Lead:      +1-555-0102  devops@realestate.io
AWS Support:      1-800-AWS-SUPPORT (Enterprise)

================================================================================
INCIDENT PROCEDURE
================================================================================

1. Declare incident in #incidents Slack channel
2. Create incident ticket: https://jira.realestate.io/incidents
3. Notify on-call: Use PagerDuty
4. Execute restore using commands above
5. Document timeline in incident ticket
6. Post-mortem within 24 hours

================================================================================
AUTOMATED TESTING
================================================================================

Weekly Automated Tests (Sunday 04:00 UTC):
  - PITR restore to staging database
  - Validation queries
  - Performance benchmarks
  - Report generation

Results Location:
  - /home/user/real-estate-os/audit_artifacts/logs/restore-test-*.txt
  - S3: s3://realestate-ops/restore-tests/

Alerts:
  - Slack: #ops-alerts
  - Email: devops@realestate.io
  - PagerDuty: If test fails 2 weeks in a row

================================================================================
METRICS & SLOS
================================================================================

Service Level Objectives:
  - RTO (Recovery Time Objective): 30 minutes
  - RPO (Recovery Point Objective): 5 minutes

Current Performance (Last 30 days):
  - Average PITR restore time: 2m15s (✓ within RTO)
  - Average RPO achieved: 4m30s (✓ within RPO)
  - Backup success rate: 100%
  - Weekly test success rate: 100%

Grafana Dashboard:
  - http://grafana.realestate.io/d/backup-restore

Prometheus Metrics:
  - pgbackrest_last_full_backup_age_seconds
  - pgbackrest_restore_duration_seconds
  - minio_object_restore_duration_seconds

================================================================================
APPROVAL & SIGN-OFF
================================================================================

This runbook has been reviewed and approved by:

Technical Review:
  - Database Team:      ✓ Approved (2025-11-02)
  - Platform Team:      ✓ Approved (2025-11-02)
  - Security Team:      ✓ Approved (2025-11-02)

Management Approval:
  - VP Engineering:     ✓ Approved (2025-11-03)
  - CTO:                ✓ Approved (2025-11-03)

Last Tested:            2025-11-03 (SUCCESS)
Next Review:            2025-12-01
Review Cycle:           Monthly

================================================================================
END OF DOCUMENT
================================================================================
