name: PR Quality Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  # ============================================================================
  # PR Metadata Checks
  # ============================================================================
  pr-validation:
    name: Validate PR
    runs-on: ubuntu-latest

    steps:
      - name: Check PR title
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          echo "PR Title: $PR_TITLE"

          # Check if title follows conventional commits
          if [[ ! "$PR_TITLE" =~ ^(feat|fix|docs|style|refactor|perf|test|chore|ci|build)(\(.+\))?: ]]; then
            echo "::warning::PR title should follow conventional commits format"
            echo "::warning::Example: 'feat(auth): Add JWT authentication'"
          fi

      - name: Check PR description
        run: |
          PR_BODY="${{ github.event.pull_request.body }}"
          if [ -z "$PR_BODY" ] || [ ${#PR_BODY} -lt 50 ]; then
            echo "::warning::PR description is too short. Please provide details about the changes."
          fi

      - name: Check PR labels
        run: |
          LABELS="${{ join(github.event.pull_request.labels.*.name, ',') }}"
          echo "PR Labels: $LABELS"

          if [ -z "$LABELS" ]; then
            echo "::warning::Consider adding labels to categorize this PR"
          fi

  # ============================================================================
  # Code Size & Complexity
  # ============================================================================
  code-metrics:
    name: Code Metrics
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Count changed lines
        run: |
          ADDITIONS=$(git diff --numstat origin/${{ github.base_ref }}...HEAD | awk '{sum+=$1} END {print sum}')
          DELETIONS=$(git diff --numstat origin/${{ github.base_ref }}...HEAD | awk '{sum+=$2} END {print sum}')
          FILES_CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)

          echo "Files changed: $FILES_CHANGED"
          echo "Lines added: $ADDITIONS"
          echo "Lines deleted: $DELETIONS"

          if [ "$FILES_CHANGED" -gt 50 ]; then
            echo "::warning::This PR changes $FILES_CHANGED files. Consider breaking it into smaller PRs."
          fi

          if [ "$ADDITIONS" -gt 1000 ]; then
            echo "::warning::This PR adds $ADDITIONS lines. Consider breaking it into smaller PRs."
          fi

      - name: Check for large files
        run: |
          LARGE_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | xargs -I {} sh -c 'wc -l {} 2>/dev/null | awk "{if (\$1 > 500) print \$2 \" has \" \$1 \" lines\"}"')

          if [ ! -z "$LARGE_FILES" ]; then
            echo "::warning::Large files detected:"
            echo "$LARGE_FILES"
          fi

  # ============================================================================
  # Test Coverage Delta
  # ============================================================================
  coverage-diff:
    name: Coverage Diff
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r api/requirements.txt
          pip install pytest pytest-cov

      - name: Set test environment
        run: |
          echo "JWT_SECRET_KEY=test-secret-key" >> $GITHUB_ENV
          echo "CORS_ORIGINS=http://localhost:3000" >> $GITHUB_ENV

      - name: Run coverage
        run: |
          pytest --cov=api/app --cov-report=json --cov-report=term

      - name: Check coverage thresholds
        run: |
          COVERAGE=$(python -c "import json; data=json.load(open('coverage.json')); print(data['totals']['percent_covered'])")
          echo "Current coverage: $COVERAGE%"

          if (( $(echo "$COVERAGE < 60" | bc -l) )); then
            echo "::error::Coverage is below 60% threshold"
            exit 1
          else
            echo "::notice::Coverage is $COVERAGE% (target: â‰¥60%)"
          fi

  # ============================================================================
  # Security Checks
  # ============================================================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Check for secrets
        run: |
          # Simple secret check (replace with proper tool like gitleaks in production)
          if grep -r "PASSWORD\|SECRET\|API_KEY" --include="*.py" --include="*.ts" --exclude-dir=tests .; then
            echo "::warning::Potential secrets detected. Ensure they're not hardcoded."
          fi

  # ============================================================================
  # Dependency Checks
  # ============================================================================
  dependencies:
    name: Dependency Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Python dependencies
        run: |
          pip install safety
          safety check --file api/requirements.txt || echo "Vulnerabilities found in Python dependencies"

      - name: Check Node dependencies
        working-directory: web
        run: |
          npm audit --audit-level=moderate || echo "Vulnerabilities found in Node dependencies"

  # ============================================================================
  # Performance Checks
  # ============================================================================
  performance:
    name: Bundle Size Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: Install dependencies
        working-directory: web
        run: npm ci

      - name: Build frontend
        working-directory: web
        run: npm run build

      - name: Check bundle size
        working-directory: web
        run: |
          BUNDLE_SIZE=$(du -sh dist | awk '{print $1}')
          echo "Bundle size: $BUNDLE_SIZE"

          # Warning if bundle is too large (adjust threshold as needed)
          BUNDLE_BYTES=$(du -s dist | awk '{print $1}')
          if [ "$BUNDLE_BYTES" -gt 10000 ]; then
            echo "::warning::Bundle size is $BUNDLE_SIZE. Consider code splitting or lazy loading."
          fi

  # ============================================================================
  # Documentation Checks
  # ============================================================================
  docs:
    name: Documentation Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for documentation updates
        run: |
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          HAS_CODE_CHANGES=$(echo "$CHANGED_FILES" | grep -E "\.(py|ts|tsx)$" || true)
          HAS_DOC_CHANGES=$(echo "$CHANGED_FILES" | grep -E "\.(md)$|^docs/" || true)

          if [ ! -z "$HAS_CODE_CHANGES" ] && [ -z "$HAS_DOC_CHANGES" ]; then
            echo "::warning::Code changes detected without documentation updates. Consider updating docs."
          fi

      - name: Check for broken links in docs
        run: |
          # Simple check for markdown files
          find docs -name "*.md" -exec grep -H "http" {} \; || echo "No external links found"
