# Authentication & Authorization Setup Guide

**PR#1: sec/auth-oidc-jwt**

This document covers the complete authentication and authorization system for Real Estate OS, including JWT tokens, API keys, rate limiting, and security headers.

## Table of Contents

1. [Overview](#overview)
2. [Environment Configuration](#environment-configuration)
3. [Database Setup](#database-setup)
4. [API Endpoints](#api-endpoints)
5. [Authentication Methods](#authentication-methods)
6. [Role-Based Access Control](#role-based-access-control)
7. [Rate Limiting](#rate-limiting)
8. [Security Headers](#security-headers)
9. [Testing](#testing)
10. [Production Deployment](#production-deployment)
11. [Troubleshooting](#troubleshooting)

---

## Overview

The authentication system provides:

- **JWT-based authentication** for web/mobile clients
- **API key authentication** for service-to-service communication
- **Role-based access control** (Owner, Admin, Analyst, Service)
- **Multi-tenant isolation** (tenant_id embedded in tokens)
- **Rate limiting** (per IP + per tenant)
- **Production-ready security** (CORS allowlist, security headers, HSTS)
- **OIDC/OAuth2 support** (optional integration with Keycloak/Auth0)

### Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                     Client Application                       │
│          (Web Frontend / Mobile App / Service)               │
└────────────────┬────────────────────────────────────────────┘
                 │
                 │ Bearer Token or X-API-Key
                 ▼
┌─────────────────────────────────────────────────────────────┐
│                      API Gateway (FastAPI)                   │
├─────────────────────────────────────────────────────────────┤
│  Rate Limiting Middleware (60/min per IP, 100/min tenant)  │
│  Security Headers Middleware (HSTS, CSP, X-Frame-Options)  │
│  CORS Middleware (production allowlist)                     │
└────────────────┬────────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────────┐
│              Authentication Dependencies                     │
│  - get_current_user: Validates JWT token                   │
│  - get_api_key_user: Validates API key                     │
│  - require_role: Checks user roles                         │
└────────────────┬────────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────────┐
│                   Protected Endpoints                        │
│  /properties, /outreach, /negotiations, etc.                │
└─────────────────────────────────────────────────────────────┘
```

---

## Environment Configuration

### Required Variables

Copy `.env.example` to `.env` and configure:

```bash
# Generate JWT secret key
python -c "import secrets; print(secrets.token_urlsafe(32))"

# Add to .env
JWT_SECRET_KEY=<generated-secret-key>
JWT_ALGORITHM=HS256
JWT_EXPIRATION_MINUTES=30
```

### Production CORS Configuration

```bash
# Development
CORS_ORIGINS=http://localhost:3000,http://localhost:5173

# Production
CORS_ORIGINS=https://app.yourdomain.com,https://admin.yourdomain.com
```

### Rate Limiting Configuration

```bash
RATE_LIMIT_PER_MINUTE=60        # Per IP address
RATE_LIMIT_PER_TENANT_MINUTE=100  # Per authenticated tenant
```

### Security Headers

```bash
ENABLE_HSTS=true  # Only enable with HTTPS in production
ENABLE_CSRF_PROTECTION=true
```

### Optional: OIDC Integration (Keycloak/Auth0)

```bash
OIDC_PROVIDER_URL=https://keycloak.yourdomain.com/auth/realms/real-estate-os
OIDC_CLIENT_ID=real-estate-os-api
OIDC_CLIENT_SECRET=<your-client-secret>
```

---

## Database Setup

### Create Migration

```bash
cd /home/user/real-estate-os/db

# Create new Alembic migration
alembic revision -m "Add authentication tables"
```

### Migration Content

```python
"""Add authentication tables

Revision ID: <auto-generated>
"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects.postgresql import UUID, ARRAY, TIMESTAMP

def upgrade():
    # Create auth_users table
    op.create_table(
        'auth_users',
        sa.Column('id', UUID(as_uuid=True), primary_key=True),
        sa.Column('tenant_id', UUID(as_uuid=True), sa.ForeignKey('tenant.id'), nullable=False),
        sa.Column('email', sa.String(255), nullable=False, unique=True),
        sa.Column('password_hash', sa.String(255), nullable=False),
        sa.Column('roles', ARRAY(sa.String), nullable=False, server_default='{}'),
        sa.Column('is_active', sa.Boolean, nullable=False, server_default='true'),
        sa.Column('created_at', TIMESTAMP(timezone=True), server_default=sa.func.now()),
        sa.Column('updated_at', TIMESTAMP(timezone=True), server_default=sa.func.now()),
        sa.Column('last_login', TIMESTAMP(timezone=True), nullable=True),
        sa.Column('oidc_provider', sa.String(50), nullable=True),
        sa.Column('oidc_sub', sa.String(255), nullable=True),
    )
    op.create_index('idx_auth_users_email', 'auth_users', ['email'])
    op.create_index('idx_auth_users_tenant_id', 'auth_users', ['tenant_id'])
    op.create_index('idx_auth_users_oidc_sub', 'auth_users', ['oidc_sub'])

    # Create auth_api_keys table
    op.create_table(
        'auth_api_keys',
        sa.Column('id', UUID(as_uuid=True), primary_key=True),
        sa.Column('tenant_id', UUID(as_uuid=True), sa.ForeignKey('tenant.id'), nullable=False),
        sa.Column('name', sa.String(100), nullable=False),
        sa.Column('description', sa.Text, nullable=True),
        sa.Column('key_hash', sa.String(255), nullable=False),
        sa.Column('key_prefix', sa.String(8), nullable=False),
        sa.Column('roles', ARRAY(sa.String), nullable=False, server_default='{}'),
        sa.Column('is_active', sa.Boolean, nullable=False, server_default='true'),
        sa.Column('created_at', TIMESTAMP(timezone=True), server_default=sa.func.now()),
        sa.Column('expires_at', TIMESTAMP(timezone=True), nullable=True),
        sa.Column('last_used', TIMESTAMP(timezone=True), nullable=True),
    )
    op.create_index('idx_auth_api_keys_key_prefix', 'auth_api_keys', ['key_prefix'])
    op.create_index('idx_auth_api_keys_tenant_id', 'auth_api_keys', ['tenant_id'])
    op.create_index('idx_auth_api_keys_is_active', 'auth_api_keys', ['is_active'])

def downgrade():
    op.drop_table('auth_api_keys')
    op.drop_table('auth_users')
```

### Run Migration

```bash
alembic upgrade head
```

---

## API Endpoints

### Public Endpoints (No Authentication Required)

#### POST /auth/register

Register new user and tenant.

**Request:**
```json
{
  "email": "user@example.com",
  "password": "securepass123",
  "tenant_name": "Acme Real Estate"
}
```

**Response (201):**
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer",
  "expires_in": 1800
}
```

#### POST /auth/login

Login with email and password.

**Request:**
```json
{
  "email": "user@example.com",
  "password": "securepass123"
}
```

**Response (200):**
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer",
  "expires_in": 1800
}
```

### Protected Endpoints (Authentication Required)

#### GET /auth/me

Get current user information.

**Headers:**
```
Authorization: Bearer <access_token>
```

**Response (200):**
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "email": "user@example.com",
  "tenant_id": "660e8400-e29b-41d4-a716-446655440000",
  "roles": ["owner"],
  "is_active": true,
  "created_at": "2025-11-01T10:00:00Z",
  "last_login": "2025-11-01T12:00:00Z"
}
```

#### POST /auth/api-keys

Create new API key (Owner/Admin only).

**Headers:**
```
Authorization: Bearer <access_token>
```

**Request:**
```json
{
  "name": "Service Integration Key",
  "description": "For automated property ingestion",
  "roles": ["service"],
  "expires_at": "2026-12-31T23:59:59Z"
}
```

**Response (200):**
```json
{
  "id": "770e8400-e29b-41d4-a716-446655440000",
  "tenant_id": "660e8400-e29b-41d4-a716-446655440000",
  "name": "Service Integration Key",
  "description": "For automated property ingestion",
  "key": "VeryLongRandomAPIKeyString...",  // Only shown once!
  "key_prefix": "VeryLong",
  "roles": ["service"],
  "is_active": true,
  "created_at": "2025-11-01T12:00:00Z",
  "expires_at": "2026-12-31T23:59:59Z",
  "last_used": null
}
```

**⚠️ Important:** Save the `key` value immediately - it cannot be retrieved later!

#### GET /auth/api-keys

List all API keys for current tenant (Owner/Admin only).

**Headers:**
```
Authorization: Bearer <access_token>
```

**Response (200):**
```json
[
  {
    "id": "770e8400-e29b-41d4-a716-446655440000",
    "tenant_id": "660e8400-e29b-41d4-a716-446655440000",
    "name": "Service Integration Key",
    "description": "For automated property ingestion",
    "key_prefix": "VeryLong",
    "roles": ["service"],
    "is_active": true,
    "created_at": "2025-11-01T12:00:00Z",
    "expires_at": "2026-12-31T23:59:59Z",
    "last_used": "2025-11-01T14:30:00Z"
  }
]
```

#### DELETE /auth/api-keys/{key_id}

Revoke (deactivate) an API key (Owner/Admin only).

**Headers:**
```
Authorization: Bearer <access_token>
```

**Response (204):**
```
No content
```

---

## Authentication Methods

### Method 1: JWT Bearer Token (for web/mobile clients)

```python
import requests

# Login
response = requests.post('http://localhost:8000/auth/login', json={
    "email": "user@example.com",
    "password": "securepass123"
})
token = response.json()["access_token"]

# Use token for authenticated requests
headers = {"Authorization": f"Bearer {token}"}
properties = requests.get('http://localhost:8000/properties', headers=headers)
```

### Method 2: API Key (for service-to-service)

```python
import requests

# Create API key (one-time, via web UI or authenticated request)
api_key = "VeryLongRandomAPIKeyString..."  # Save securely!

# Use API key for authenticated requests
headers = {"X-API-Key": api_key}
properties = requests.get('http://localhost:8000/properties', headers=headers)
```

### JWT Token Payload

Decoded JWT contains:

```json
{
  "sub": "550e8400-e29b-41d4-a716-446655440000",  // User ID
  "tenant_id": "660e8400-e29b-41d4-a716-446655440000",
  "roles": ["owner"],
  "exp": 1698854400  // Expiration timestamp
}
```

---

## Role-Based Access Control

### Roles

| Role | Description | Permissions |
|------|-------------|-------------|
| `owner` | Tenant owner | Full access to all resources, manage users, manage API keys |
| `admin` | Administrator | Manage resources, manage API keys, cannot delete tenant |
| `analyst` | Read-only analyst | View properties, scorecards, analytics - no write access |
| `service` | Service account | For API keys - programmable access with scoped permissions |

### Using Role-Based Dependencies

```python
from fastapi import Depends, APIRouter
from app.auth.dependencies import require_role, get_current_user
from app.auth.models import Role, User

router = APIRouter()

# Endpoint accessible only to owners and admins
@router.delete("/properties/{id}")
def delete_property(
    id: str,
    current_user: User = Depends(require_role([Role.OWNER, Role.ADMIN]))
):
    # Delete property
    pass

# Endpoint accessible to any authenticated user
@router.get("/properties")
def list_properties(current_user: User = Depends(get_current_user)):
    # Use current_user.tenant_id for filtering
    pass
```

---

## Rate Limiting

### Configuration

- **Per IP**: 60 requests/minute (default)
- **Per Tenant**: 100 requests/minute (default)
- **Excluded**: `/healthz`, `/ping` endpoints

### Response Headers

All responses include rate limit headers:

```
X-RateLimit-Limit-IP: 60
X-RateLimit-Remaining-IP: 45
```

### When Rate Limit Exceeded

**Response (429):**
```json
{
  "detail": "Rate limit exceeded. Please try again later."
}
```

**Headers:**
```
X-RateLimit-Limit: 60
X-RateLimit-Remaining: 0
X-RateLimit-Reset: 60
Retry-After: 60
```

### Production Scaling

For production, migrate to Redis-based rate limiting:

```python
# api/app/middleware/rate_limit.py (future enhancement)
import redis

redis_client = redis.Redis(host='localhost', port=6379, db=0)
# Use Redis for distributed rate limiting across multiple API instances
```

---

## Security Headers

The API automatically adds security headers to all responses:

```
Strict-Transport-Security: max-age=31536000; includeSubDomains  (if ENABLE_HSTS=true)
X-Content-Type-Options: nosniff
X-Frame-Options: DENY
X-XSS-Protection: 1; mode=block
Content-Security-Policy: default-src 'self'; ...
Referrer-Policy: strict-origin-when-cross-origin
```

---

## Testing

### Run Auth Tests

```bash
cd /home/user/real-estate-os

# Run all auth tests
pytest tests/test_auth.py -v

# Run specific test
pytest tests/test_auth.py::test_register_new_user -v

# Run with coverage
pytest tests/test_auth.py --cov=api/app/auth --cov-report=html
```

### Manual Testing

```bash
# 1. Register user
curl -X POST http://localhost:8000/auth/register \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"securepass123","tenant_name":"Test Org"}'

# 2. Login
curl -X POST http://localhost:8000/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"securepass123"}'

# Save token
TOKEN="<access_token_from_response>"

# 3. Get user info
curl -X GET http://localhost:8000/auth/me \
  -H "Authorization: Bearer $TOKEN"

# 4. Create API key
curl -X POST http://localhost:8000/auth/api-keys \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"name":"Test Key","roles":["service"]}'

# Save API key
API_KEY="<key_from_response>"

# 5. Test API key authentication
curl -X GET http://localhost:8000/properties \
  -H "X-API-Key: $API_KEY"
```

---

## Production Deployment

### Checklist

- [ ] **JWT Secret**: Generate strong secret key with `secrets.token_urlsafe(32)`
- [ ] **CORS**: Update `CORS_ORIGINS` to production domains only
- [ ] **HTTPS**: Enable HSTS with `ENABLE_HSTS=true`
- [ ] **Rate Limiting**: Tune limits for production load
- [ ] **Database**: Run migrations on production database
- [ ] **Monitoring**: Set up alerts for rate limit violations
- [ ] **Secrets**: Use Vault/SOPS (not environment variables) for JWT secret
- [ ] **API Keys**: Document rotation procedure
- [ ] **Logging**: Enable audit logs for auth events
- [ ] **OIDC**: Configure Keycloak/Auth0 for SSO (optional)

### Secrets Management (Production)

**Never store JWT_SECRET_KEY in environment variables in production!**

Use Vault or SOPS:

```bash
# HashiCorp Vault
vault kv put secret/real-estate-os JWT_SECRET_KEY="$(python -c 'import secrets; print(secrets.token_urlsafe(32))')"

# SOPS (with AWS KMS)
echo "JWT_SECRET_KEY: $(python -c 'import secrets; print(secrets.token_urlsafe(32))')" | \
  sops --encrypt --kms <kms-key-arn> /dev/stdin > secrets.enc.yaml
```

### API Key Rotation Procedure

1. Create new API key for service
2. Update service configuration with new key
3. Deploy service with new key
4. Verify service is working
5. Revoke old API key via `/auth/api-keys/{id}` DELETE

---

## Troubleshooting

### "JWT_SECRET_KEY environment variable must be set"

**Solution:** Add JWT_SECRET_KEY to .env file:

```bash
python -c "import secrets; print(secrets.token_urlsafe(32))"
# Copy output to .env
JWT_SECRET_KEY=<generated-value>
```

### "Could not validate credentials: Token has expired"

**Solution:** Token expired (default: 30 minutes). Login again to get new token.

### "Rate limit exceeded"

**Solution:** Wait 60 seconds or increase `RATE_LIMIT_PER_MINUTE` in .env.

### "CORS error in browser"

**Solution:** Add your frontend origin to `CORS_ORIGINS` in .env:

```bash
CORS_ORIGINS=http://localhost:3000,http://localhost:5173
```

### "API key invalid"

**Possible causes:**
1. API key was revoked (check with GET /auth/api-keys)
2. API key expired (check `expires_at`)
3. Wrong tenant (API keys are tenant-scoped)

---

## Security Best Practices

1. **Use HTTPS in production** - Enable HSTS
2. **Rotate JWT secret key** - Every 90 days
3. **Rotate API keys** - Every 180 days or when compromised
4. **Monitor rate limits** - Alert on frequent 429 responses
5. **Audit auth events** - Log all login/logout/key creation
6. **Use strong passwords** - Enforce 12+ characters
7. **Enable MFA** - Add TOTP in future enhancement (PR#X)
8. **Limit token lifetime** - Default 30 minutes is reasonable
9. **Validate OIDC tokens** - If using Keycloak/Auth0
10. **Scan for vulnerabilities** - Run OWASP ZAP baseline

---

## Next Steps

- **PR#2**: Add comprehensive test suite (pytest + coverage gates)
- **PR#4**: Add observability (OpenTelemetry, Sentry)
- **PR#5**: Add Redis caching for rate limiting and sessions
- **Future**: Add MFA (TOTP), password reset, email verification

---

## References

- [FastAPI Security Documentation](https://fastapi.tiangolo.com/tutorial/security/)
- [JWT.io](https://jwt.io/)
- [OWASP Authentication Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Authentication_Cheat_Sheet.html)
- [OAuth 2.0 RFC](https://tools.ietf.org/html/rfc6749)
- [OpenID Connect Specification](https://openid.net/specs/openid-connect-core-1_0.html)
